CREATE                   PROCEDURE [fpx].[usp_AFA_join]
AS
BEGIN
    SET NOCOUNT ON;

    IF OBJECT_ID('[fpx].[Report_AFA_Join]', 'U') IS NULL
    BEGIN
        SELECT
             sch.[ScheduledFlightId] AS [sch_ScheduledFlightId],
  sch.[OpsAircraftType] AS [sch_OpsAircraftType],
  sch.[Registration] AS [sch_Registration],
  sch.[AirlineDesignator] AS [sch_AirlineDesignator],
  sch.[FlightNumber] AS [sch_FlightNumber],
  sch.[Suffix] AS [sch_Suffix],
  sch.[ScheduledDepartureDate] AS [sch_ScheduledDepartureDate],
  sch.[Departure] AS [sch_Departure],
  sch.[DepartureTime] AS [sch_DepartureTime],
  sch.[Destination] AS [sch_Destination],
  sch.[DestinationTime] AS [sch_DestinationTime],
  sch.[TimeMode] AS [sch_TimeMode],
  sch.[DomInt] AS [sch_DomInt],
  sch.[UpliftQuantity] AS [sch_UpliftQuantity],
  sch.[OriginalCustomer] AS [sch_OriginalCustomer],
  sch.[ReportedCustomer] AS [sch_ReportedCustomer],
  sch.[FlightType] AS [sch_FlightType],
  sch.[ServiceType] AS [sch_ServiceType],
  sch.[FlightSeqNo] AS [sch_FlightSeqNo],
  sch.[Division] AS [sch_Division],
  sch.[MissionId] AS [sch_MissionId],
  sch.[CharterContractNo] AS [sch_CharterContractNo],
  sch.[EstimatedBlockTime] AS [sch_EstimatedBlockTime],
  sch.[EstimatedBlockTimeDec] AS [sch_EstimatedBlockTimeDec],
  sch.[EstimatedParkingTime] AS [sch_EstimatedParkingTime],
  sch.[EstimatedParkingTimeDec] AS [sch_EstimatedParkingTimeDec],
  sch.[DepartureTimeUTC] AS [sch_DepartureTimeUTC],
  sch.[DepartureTimeLT] AS [sch_DepartureTimeLT],
  sch.[DestinationTimeUTC] AS [sch_DestinationTimeUTC],
  sch.[DestinationTimeLT] AS [sch_DestinationTimeLT],
  sch.[CUST_CO_ID] AS [sch_CUST_CO_ID],
  sch.[Customer] AS [sch_Customer],
  sch.[FINAL_CUST_CO_ID] AS [sch_FINAL_CUST_CO_ID],
  sch.[FinalCustomer] AS [sch_FinalCustomer],
  sch.[SUPPL_CO_ID] AS [sch_SUPPL_CO_ID],
  sch.[Supplier] AS [sch_Supplier],
  sch.[FUELER_CO_ID] AS [sch_FUELER_CO_ID],
  sch.[Fueler] AS [sch_Fueler],
  sch.[FuelSupplySearchResult] AS [sch_FuelSupplySearchResult],
  sch.[HasErrors] AS [sch_HasErrors],
  sch.[IsBillable] AS [sch_IsBillable],
  sch.[FlightStatus] AS [sch_FlightStatus],
  sch.[CancellationCode] AS [sch_CancellationCode],
  sch.[CancellationReason] AS [sch_CancellationReason],
  sch.[MessageSent] AS [sch_MessageSent],
  sch.[MessageSentDate] AS [sch_MessageSentDate],
  sch.[EFF_SUPPL_CO_ID] AS [sch_EFF_SUPPL_CO_ID],
  sch.[EffectiveSupplier] AS [sch_EffectiveSupplier],
  sch.[EFF_FUELER_CO_ID] AS [sch_EFF_FUELER_CO_ID],
  sch.[EffectiveFueler] AS [sch_EffectiveFueler],
  sch.[EffectiveFuelSupplySearchResult] AS [sch_EffectiveFuelSupplySearchResult],
  sch.[SysPrice] AS [sch_SysPrice],
  sch.[SysPriceDate] AS [sch_SysPriceDate],
  sch.[UserPrice] AS [sch_UserPrice],
  sch.[UserPriceDate] AS [sch_UserPriceDate],
  sch.[Amount] AS [sch_Amount],
  GEO.[LOC_ID] AS [GEO_LOC_ID],
  GEO.[LocationCode] AS [GEO_LocationCode],
  GEO.[LocationName] AS [GEO_LocationName],
  GEO.[LocationIATACode] AS [GEO_LocationIATACode],
  GEO.[LocationICAOCode] AS [GEO_LocationICAOCode],
  GEO.[IsAirport] AS [GEO_IsAirport],
  GEO.[IsMonopolistic] AS [GEO_IsMonopolistic],
  GEO.[CNTRY_ID] AS [GEO_CNTRY_ID],
  GEO.[CountryName] AS [GEO_CountryName],
  GEO.[CountryISOCode] AS [GEO_CountryISOCode],
  GEO.[Continent] AS [GEO_Continent],
  GEO.[StateCode] AS [GEO_StateCode],
  GEO.[StateName] AS [GEO_StateName],
  act.[FlightID] AS [act_FlightID],
  act.[FlightDate] AS [act_FlightDate],
  act.[Registration] AS [act_Registration],
  act.[Departure] AS [act_Departure],
  act.[Destination] AS [act_Destination],
  act.[AirlineDesignator] AS [act_AirlineDesignator],
  act.[FlightNumber] AS [act_FlightNumber],
  act.[Suffix] AS [act_Suffix],
  act.[AircraftID] AS [act_AircraftID],
  act.[AircraftType] AS [act_AircraftType],
  act.[OpsAircraftType] AS [act_OpsAircraftType],
  act.[Leg] AS [act_Leg],
  act.[LegAircraftType] AS [act_LegAircraftType],
  act.[SpecialEvent] AS [act_SpecialEvent],
  act.[DomInt] AS [act_DomInt],
  act.[DepartureDate] AS [act_DepartureDate],
  act.[OffBlockTimeUTC] AS [act_OffBlockTimeUTC],
  act.[TakeOffTimeUTC] AS [act_TakeOffTimeUTC],
  act.[TouchDownTimeUTC] AS [act_TouchDownTimeUTC],
  act.[OnBlockTimeUTC] AS [act_OnBlockTimeUTC],
  act.[BlockTime] AS [act_BlockTime],
  act.[FlightTime] AS [act_FlightTime],
  act.[Operator] AS [act_Operator],
  act.[Owner] AS [act_Owner],
  act.[Customer] AS [act_Customer],
  act.[UpliftVol] AS [act_UpliftVol],
  act.[UpliftMass] AS [act_UpliftMass],
  act.[UpliftDensity] AS [act_UpliftDensity],
  act.[UpliftStatus] AS [act_UpliftStatus],
  act.[UpliftCost] AS [act_UpliftCost],
  act.[IPStatus] AS [act_IPStatus],
  act.[BeforeFuelingVol] AS [act_BeforeFuelingVol],
  act.[BeforeFuelingMass] AS [act_BeforeFuelingMass],
  act.[OffBlockFuelVol] AS [act_OffBlockFuelVol],
  act.[OffBlockFuelMass] AS [act_OffBlockFuelMass],
  act.[ShutDownFuelVol] AS [act_ShutDownFuelVol],
  act.[ShutDownFuelMass] AS [act_ShutDownFuelMass],
  act.[FuelDumpVol] AS [act_FuelDumpVol],
  act.[FuelDumpMass] AS [act_FuelDumpMass],
  act.[BlockConsumptionVol] AS [act_BlockConsumptionVol],
  act.[BlockConsumptionMass] AS [act_BlockConsumptionMass],
  act.[BlockConsumptionStatus] AS [act_BlockConsumptionStatus],
  act.[TotalConsumptionVol] AS [act_TotalConsumptionVol],
  act.[TotalConsumptionMass] AS [act_TotalConsumptionMass],
  act.[TotalConsumptionStatus] AS [act_TotalConsumptionStatus],
  act.[BlockConsumptionCost] AS [act_BlockConsumptionCost],
  act.[TotalConsumptionCost] AS [act_TotalConsumptionCost],
  act.[APUConsumptionVol] AS [act_APUConsumptionVol],
  act.[APUConsumptionMass] AS [act_APUConsumptionMass],
  act.[APUConsumptionCost] AS [act_APUConsumptionCost],
  act.[TankeredFuelVol] AS [act_TankeredFuelVol],
  act.[TankeredFuelMass] AS [act_TankeredFuelMass],
  act.[Division] AS [act_Division],
  act.[FlightSeqNo] AS [act_FlightSeqNo],
  act.[FlightType] AS [act_FlightType],
  act.[ServiceType] AS [act_ServiceType],
  act.[ReportedCustomer] AS [act_ReportedCustomer],
  act.[FinalCustomer] AS [act_FinalCustomer],
  act.[LegDistance] AS [act_LegDistance],
  act.[CharterContractNo] AS [act_CharterContractNo],
  act.[Terminal] AS [act_Terminal],
  act.[GateNo] AS [act_GateNo],
  act.[StandNo] AS [act_StandNo],
  act.[AirportArea] AS [act_AirportArea],
CONCAT(YEAR(sch.[ScheduledDepartureDate]), '-', RIGHT('00' + CONVERT(varchar(2), MONTH(sch.[ScheduledDepartureDate])), 2)) AS [Sch_ScheduledDepartureDate_Month],
CONCAT(YEAR(sch.[DepartureTimeUTC]),       '-', RIGHT('00' + CONVERT(varchar(2), MONTH(sch.[DepartureTimeUTC])),       2)) AS [Sch_DepartureTimeUTC_Month],
CONCAT(YEAR(act.[DepartureDate]),          '-', RIGHT('00' + CONVERT(varchar(2), MONTH(act.[DepartureDate])),          2)) AS [Act_DepartureDate_Month],
    act.[Departure] + '-' + act.[Destination]   AS [Route]
INTO [fpx_raw].[Report_AFA_Join]
FROM [LH_ATGIQ].[fpx_raw].[V_ANLF_AFAScheduledFlightsAndCosts] sch
Full OUTER JOIN [LH_ATGIQ].[fpx_raw].[V_ANLF_ActualFlights] act ON sch.[FlightSeqNo] = act.[FlightSeqNo]
LEFT OUTER JOIN [LH_ATGIQ].[fpx_raw].[V_ANLD_Geography] GEO ON GEO.[LocationIATACode] = sch.[Departure]
    END
    ELSE
    BEGIN
        TRUNCATE TABLE [fpx].[Report_AFA_Join];

        INSERT INTO [fpx].[Report_AFA_Join]
        SELECT
             sch.[ScheduledFlightId] AS [sch_ScheduledFlightId],
  sch.[OpsAircraftType] AS [sch_OpsAircraftType],
  sch.[Registration] AS [sch_Registration],
  sch.[AirlineDesignator] AS [sch_AirlineDesignator],
  sch.[FlightNumber] AS [sch_FlightNumber],
  sch.[Suffix] AS [sch_Suffix],
  sch.[ScheduledDepartureDate] AS [sch_ScheduledDepartureDate],
  sch.[Departure] AS [sch_Departure],
  sch.[DepartureTime] AS [sch_DepartureTime],
  sch.[Destination] AS [sch_Destination],
  sch.[DestinationTime] AS [sch_DestinationTime],
  sch.[TimeMode] AS [sch_TimeMode],
  sch.[DomInt] AS [sch_DomInt],
  sch.[UpliftQuantity] AS [sch_UpliftQuantity],
  sch.[OriginalCustomer] AS [sch_OriginalCustomer],
  sch.[ReportedCustomer] AS [sch_ReportedCustomer],
  sch.[FlightType] AS [sch_FlightType],
  sch.[ServiceType] AS [sch_ServiceType],
  sch.[FlightSeqNo] AS [sch_FlightSeqNo],
  sch.[Division] AS [sch_Division],
  sch.[MissionId] AS [sch_MissionId],
  sch.[CharterContractNo] AS [sch_CharterContractNo],
  sch.[EstimatedBlockTime] AS [sch_EstimatedBlockTime],
  sch.[EstimatedBlockTimeDec] AS [sch_EstimatedBlockTimeDec],
  sch.[EstimatedParkingTime] AS [sch_EstimatedParkingTime],
  sch.[EstimatedParkingTimeDec] AS [sch_EstimatedParkingTimeDec],
  sch.[DepartureTimeUTC] AS [sch_DepartureTimeUTC],
  sch.[DepartureTimeLT] AS [sch_DepartureTimeLT],
  sch.[DestinationTimeUTC] AS [sch_DestinationTimeUTC],
  sch.[DestinationTimeLT] AS [sch_DestinationTimeLT],
  sch.[CUST_CO_ID] AS [sch_CUST_CO_ID],
  sch.[Customer] AS [sch_Customer],
  sch.[FINAL_CUST_CO_ID] AS [sch_FINAL_CUST_CO_ID],
  sch.[FinalCustomer] AS [sch_FinalCustomer],
  sch.[SUPPL_CO_ID] AS [sch_SUPPL_CO_ID],
  sch.[Supplier] AS [sch_Supplier],
  sch.[FUELER_CO_ID] AS [sch_FUELER_CO_ID],
  sch.[Fueler] AS [sch_Fueler],
  sch.[FuelSupplySearchResult] AS [sch_FuelSupplySearchResult],
  sch.[HasErrors] AS [sch_HasErrors],
  sch.[IsBillable] AS [sch_IsBillable],
  sch.[FlightStatus] AS [sch_FlightStatus],
  sch.[CancellationCode] AS [sch_CancellationCode],
  sch.[CancellationReason] AS [sch_CancellationReason],
  sch.[MessageSent] AS [sch_MessageSent],
  sch.[MessageSentDate] AS [sch_MessageSentDate],
  sch.[EFF_SUPPL_CO_ID] AS [sch_EFF_SUPPL_CO_ID],
  sch.[EffectiveSupplier] AS [sch_EffectiveSupplier],
  sch.[EFF_FUELER_CO_ID] AS [sch_EFF_FUELER_CO_ID],
  sch.[EffectiveFueler] AS [sch_EffectiveFueler],
  sch.[EffectiveFuelSupplySearchResult] AS [sch_EffectiveFuelSupplySearchResult],
  sch.[SysPrice] AS [sch_SysPrice],
  sch.[SysPriceDate] AS [sch_SysPriceDate],
  sch.[UserPrice] AS [sch_UserPrice],
  sch.[UserPriceDate] AS [sch_UserPriceDate],
  sch.[Amount] AS [sch_Amount],
  GEO.[LOC_ID] AS [GEO_LOC_ID],
  GEO.[LocationCode] AS [GEO_LocationCode],
  GEO.[LocationName] AS [GEO_LocationName],
  GEO.[LocationIATACode] AS [GEO_LocationIATACode],
  GEO.[LocationICAOCode] AS [GEO_LocationICAOCode],
  GEO.[IsAirport] AS [GEO_IsAirport],
  GEO.[IsMonopolistic] AS [GEO_IsMonopolistic],
  GEO.[CNTRY_ID] AS [GEO_CNTRY_ID],
  GEO.[CountryName] AS [GEO_CountryName],
  GEO.[CountryISOCode] AS [GEO_CountryISOCode],
  GEO.[Continent] AS [GEO_Continent],
  GEO.[StateCode] AS [GEO_StateCode],
  GEO.[StateName] AS [GEO_StateName],
  act.[FlightID] AS [act_FlightID],
  act.[FlightDate] AS [act_FlightDate],
  act.[Registration] AS [act_Registration],
  act.[Departure] AS [act_Departure],
  act.[Destination] AS [act_Destination],
  act.[AirlineDesignator] AS [act_AirlineDesignator],
  act.[FlightNumber] AS [act_FlightNumber],
  act.[Suffix] AS [act_Suffix],
  act.[AircraftID] AS [act_AircraftID],
  act.[AircraftType] AS [act_AircraftType],
  act.[OpsAircraftType] AS [act_OpsAircraftType],
  act.[Leg] AS [act_Leg],
  act.[LegAircraftType] AS [act_LegAircraftType],
  act.[SpecialEvent] AS [act_SpecialEvent],
  act.[DomInt] AS [act_DomInt],
  act.[DepartureDate] AS [act_DepartureDate],
  act.[OffBlockTimeUTC] AS [act_OffBlockTimeUTC],
  act.[TakeOffTimeUTC] AS [act_TakeOffTimeUTC],
  act.[TouchDownTimeUTC] AS [act_TouchDownTimeUTC],
  act.[OnBlockTimeUTC] AS [act_OnBlockTimeUTC],
  act.[BlockTime] AS [act_BlockTime],
  act.[FlightTime] AS [act_FlightTime],
  act.[Operator] AS [act_Operator],
  act.[Owner] AS [act_Owner],
  act.[Customer] AS [act_Customer],
  act.[UpliftVol] AS [act_UpliftVol],
  act.[UpliftMass] AS [act_UpliftMass],
  act.[UpliftDensity] AS [act_UpliftDensity],
  act.[UpliftStatus] AS [act_UpliftStatus],
  act.[UpliftCost] AS [act_UpliftCost],
  act.[IPStatus] AS [act_IPStatus],
  act.[BeforeFuelingVol] AS [act_BeforeFuelingVol],
  act.[BeforeFuelingMass] AS [act_BeforeFuelingMass],
  act.[OffBlockFuelVol] AS [act_OffBlockFuelVol],
  act.[OffBlockFuelMass] AS [act_OffBlockFuelMass],
  act.[ShutDownFuelVol] AS [act_ShutDownFuelVol],
  act.[ShutDownFuelMass] AS [act_ShutDownFuelMass],
  act.[FuelDumpVol] AS [act_FuelDumpVol],
  act.[FuelDumpMass] AS [act_FuelDumpMass],
  act.[BlockConsumptionVol] AS [act_BlockConsumptionVol],
  act.[BlockConsumptionMass] AS [act_BlockConsumptionMass],
  act.[BlockConsumptionStatus] AS [act_BlockConsumptionStatus],
  act.[TotalConsumptionVol] AS [act_TotalConsumptionVol],
  act.[TotalConsumptionMass] AS [act_TotalConsumptionMass],
  act.[TotalConsumptionStatus] AS [act_TotalConsumptionStatus],
  act.[BlockConsumptionCost] AS [act_BlockConsumptionCost],
  act.[TotalConsumptionCost] AS [act_TotalConsumptionCost],
  act.[APUConsumptionVol] AS [act_APUConsumptionVol],
  act.[APUConsumptionMass] AS [act_APUConsumptionMass],
  act.[APUConsumptionCost] AS [act_APUConsumptionCost],
  act.[TankeredFuelVol] AS [act_TankeredFuelVol],
  act.[TankeredFuelMass] AS [act_TankeredFuelMass],
  act.[Division] AS [act_Division],
  act.[FlightSeqNo] AS [act_FlightSeqNo],
  act.[FlightType] AS [act_FlightType],
  act.[ServiceType] AS [act_ServiceType],
  act.[ReportedCustomer] AS [act_ReportedCustomer],
  act.[FinalCustomer] AS [act_FinalCustomer],
  act.[LegDistance] AS [act_LegDistance],
  act.[CharterContractNo] AS [act_CharterContractNo],
  act.[Terminal] AS [act_Terminal],
  act.[GateNo] AS [act_GateNo],
  act.[StandNo] AS [act_StandNo],
  act.[AirportArea] AS [act_AirportArea],
 CONCAT(YEAR(sch.[ScheduledDepartureDate]), '-', RIGHT('00' + CONVERT(varchar(2), MONTH(sch.[ScheduledDepartureDate])), 2)) AS [Sch_ScheduledDepartureDate_Month],
CONCAT(YEAR(sch.[DepartureTimeUTC]),       '-', RIGHT('00' + CONVERT(varchar(2), MONTH(sch.[DepartureTimeUTC])),       2)) AS [Sch_DepartureTimeUTC_Month],
CONCAT(YEAR(act.[DepartureDate]),          '-', RIGHT('00' + CONVERT(varchar(2), MONTH(act.[DepartureDate])),          2)) AS [Act_DepartureDate_Month],
			  act.[Departure] + '-' + act.[Destination]   AS [Route]

FROM [LH_ATGIQ].[fpx_raw].[V_ANLF_AFAScheduledFlightsAndCosts] sch
Full OUTER JOIN [LH_ATGIQ].[fpx_raw].[V_ANLF_ActualFlights] act ON sch.[FlightSeqNo] = act.[FlightSeqNo]
LEFT OUTER JOIN [LH_ATGIQ].[fpx_raw].[V_ANLD_Geography] GEO ON GEO.[LocationIATACode] = sch.[Departure]

    END
END